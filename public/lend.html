<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>貸出ページ</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="header">
  <button onclick="location.href='staff_menu.html'" class="staff-only" style="display:none">
    〇執管理メニューへ戻る
  </button>
  <h1>貸出</h1>
  <button id="logoutBtn">ログアウト</button>
</div>

<form id="lendForm">
  <label>部屋名：
    <input type="text" id="roomInput" required placeholder="例: A1外">
  </label><br>

  <label>物品：
    <select id="itemSelect" required></select>
  </label><br>

  <label>数量：
    <select id="qtySelect" required></select>
  </label><br>

  <label>〇執対応者：
    <select id="fromSelect" required></select>
  </label><br><br>

  <button type="submit">貸出</button>
</form>

<div class="footer">
  <button onclick="location.href='return.html'">返却ページ</button>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    getDoc,
    doc,
    addDoc,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let currentUser = null;
  let isStaff = false;
  let itemsCache = [];

  /**********************
   * 認証 & 権限判定
   **********************/
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }

    currentUser = user;
    const snap = await getDoc(doc(db, "users", user.uid));

    if (!snap.exists()) {
      alert("ユーザー情報がありません");
      await signOut(auth);
      return;
    }

    isStaff = snap.data().role === "staff";

    if (isStaff) {
      document.querySelectorAll(".staff-only").forEach(el => {
        el.style.display = "inline-block";
      });
    }

    loadData();
  });

  /**********************
   * ログアウト
   **********************/
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    location.href = "login.html";
  });

  /**********************
   * データロード
   **********************/
  async function loadData() {
    // --- items ---
    const itemSnap = await getDocs(collection(db, "items"));
    itemsCache = [];

    const itemSelect = document.getElementById("itemSelect");
    itemSelect.innerHTML = "";

    itemSnap.forEach(d => {
      const i = d.data();
      if (i.available > 0) {
        itemsCache.push({ id: d.id, ...i });

        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = `${i.category} - ${i.name}（残:${i.available}）`;
        opt.dataset.available = i.available;
        itemSelect.appendChild(opt);
      }
    });

    updateQtyOptions();

    // --- lenders ---
    const lenderSnap = await getDocs(collection(db, "lenders"));
    const fromSelect = document.getElementById("fromSelect");
    fromSelect.innerHTML = "";

    lenderSnap.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.data().name;
      fromSelect.appendChild(opt);
    });
  }

  /**********************
   * 数量選択更新
   **********************/
  function updateQtyOptions() {
    const itemSelect = document.getElementById("itemSelect");
    const qtySelect = document.getElementById("qtySelect");
    qtySelect.innerHTML = "";

    if (!itemSelect.selectedOptions.length) return;
    const available = Number(itemSelect.selectedOptions[0].dataset.available);

    for (let i = 1; i <= available; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      qtySelect.appendChild(opt);
    }
  }

  document.getElementById("itemSelect").addEventListener("change", updateQtyOptions);

  /**********************
   * 貸出処理
   **********************/
  document.getElementById("lendForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const itemId = document.getElementById("itemSelect").value;
    const qty = Number(document.getElementById("qtySelect").value);
    const room = document.getElementById("roomInput").value;
    const lenderId = document.getElementById("fromSelect").value;

    const item = itemsCache.find(i => i.id === itemId);
    if (!item || item.available < qty) {
      alert("在庫が不足しています");
      return;
    }

    // 在庫更新
    await updateDoc(doc(db, "items", itemId), {
      available: item.available - qty
    });

    // 貸出記録
    await addDoc(collection(db, "loans"), {
      item_id: itemId,
      item_name: item.name,
      qty,
      room,
      lender_id: lenderId,
      borrowed_at: serverTimestamp(),
      returned_at: null,
      staff_uid: currentUser.uid
    });

    alert("貸出しました！");
    document.getElementById("lendForm").reset();
    loadData();
  });
</script>

</body>
</html>
