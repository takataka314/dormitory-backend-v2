<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>物品一括追加</title>
<style>
  body { font-family: Arial; padding: 20px; }
  input { padding: 6px; margin-right: 10px; margin-bottom: 10px; }
  button { padding: 6px 12px; }
  #itemsList { margin-top: 20px; border-collapse: collapse; }
  #itemsList th, #itemsList td { padding: 6px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1>物品追加ページ（スタッフ専用）</h1>

<div>
  <input type="text" id="category" placeholder="カテゴリー">
  <input type="text" id="name" placeholder="物品名">
  <input type="number" id="stock" placeholder="個数" min="1">
  <button id="addBtn">リストに追加</button>
</div>

<h3>追加予定リスト</h3>
<table id="itemsList">
  <thead>
    <tr>
      <th>カテゴリー</th>
      <th>物品名</th>
      <th>個数</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="submitBtn">一括追加</button>

<p>
  <a href="staff_menu.html">スタッフメニューへ戻る</a>
</p>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    doc,
    writeBatch,
    serverTimestamp,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const itemsToAdd = [];

  /************************
   * 認証 & スタッフ判定
   ************************/
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists() || snap.data().role !== "staff") {
      alert("スタッフ専用ページです");
      await signOut(auth);
      location.href = "login.html";
      return;
    }
  });

  /************************
   * リスト操作
   ************************/
  document.getElementById("addBtn").addEventListener("click", () => {
    const category = document.getElementById("category").value.trim();
    const name = document.getElementById("name").value.trim();
    const stock = Number(document.getElementById("stock").value);

    if (!category || !name || stock <= 0) {
      alert("全て正しく入力してください");
      return;
    }

    itemsToAdd.push({ category, name, stock });
    renderItems();

    document.getElementById("category").value = "";
    document.getElementById("name").value = "";
    document.getElementById("stock").value = "";
  });

  function renderItems() {
    const tbody = document.querySelector("#itemsList tbody");
    tbody.innerHTML = "";

    itemsToAdd.forEach((item, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.category}</td>
        <td>${item.name}</td>
        <td>${item.stock}</td>
        <td><button data-idx="${idx}">削除</button></td>
      `;
      tr.querySelector("button").onclick = () => {
        itemsToAdd.splice(idx, 1);
        renderItems();
      };
      tbody.appendChild(tr);
    });
  }

  /************************
   * Firestoreへ一括追加
   ************************/
  document.getElementById("submitBtn").addEventListener("click", async () => {
    if (itemsToAdd.length === 0) {
      alert("追加する物品がありません");
      return;
    }

    try {
      const batch = writeBatch(db);
      const colRef = collection(db, "items");

      itemsToAdd.forEach(item => {
        const ref = doc(colRef);
        batch.set(ref, {
          category: item.category,
          name: item.name,
          available: item.stock,
          createdAt: serverTimestamp()
        });
      });

      await batch.commit();

      alert("追加完了！");
      itemsToAdd.length = 0;
      renderItems();

    } catch (err) {
      console.error(err);
      alert("追加中にエラーが発生しました");
    }
  });
</script>

</body>
</html>
