<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>返却ページ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    tr.selected { background: #e0f0ff; }
  </style>
</head>
<body>

<div class="header">
  <button
    onclick="location.href='staff_menu.html'"
    class="staff-only"
    style="display:none">
    〇執管理メニューへ戻る
  </button>
  <h1>返却</h1>
  <button id="logoutBtn">ログアウト</button>
</div>

<table id="loansTable">
  <thead>
    <tr>
      <th>返却</th>
      <th>部屋</th>
      <th>借りた人</th>
      <th>物品</th>
      <th>個数</th>
      <th>〇執対応者</th>
      <th>貸出日時</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="returnBtn">返却する</button>

<div class="footer">
  <button onclick="location.href='lend.html'">貸出ページ</button>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    query,
    where,
    doc,
    runTransaction,
    serverTimestamp,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let isStaff = false;

  /**********************
   * 認証 & スタッフ判定
   **********************/
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }

    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists() && snap.data().role === "staff") {
      isStaff = true;
      document.querySelectorAll(".staff-only").forEach(el => {
        el.style.display = "inline-block";
      });
    }

    loadUnreturned();
  });

  /**********************
   * ログアウト
   **********************/
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    location.href = "login.html";
  });

  /**********************
   * 未返却一覧ロード
   **********************/
  async function loadUnreturned() {
    const tbody = document.querySelector("#loansTable tbody");
    tbody.innerHTML = "";

    const snap = await getDocs(
      query(collection(db, "loans"), where("returned_at", "==", null))
    );

    snap.forEach(d => {
      const r = d.data();
      const tr = document.createElement("tr");
      tr.dataset.id = d.id;

      tr.innerHTML = `
        <td><input type="checkbox" class="row-check"></td>
        <td>${r.room}</td>
        <td>${r.user_name || ""}</td>
        <td>${r.item_name}</td>
        <td>${r.qty}</td>
        <td>${r.lender_name || ""}</td>
        <td>${formatDate(r.borrowed_at)}</td>
      `;

      const checkbox = tr.querySelector(".row-check");
      checkbox.addEventListener("change", () => {
        tr.classList.toggle("selected", checkbox.checked);
      });

      tbody.appendChild(tr);
    });
  }

  /**********************
   * 複数返却処理（transaction）
   **********************/
  document.getElementById("returnBtn").addEventListener("click", async () => {
    const selected = [...document.querySelectorAll(".row-check:checked")];
    if (selected.length === 0) {
      alert("返却する行を選択してください（複数可）");
      return;
    }

    try {
      for (const chk of selected) {
        const loanId = chk.closest("tr").dataset.id;

        await runTransaction(db, async (tx) => {
          const loanRef = doc(db, "loans", loanId);
          const loanSnap = await tx.get(loanRef);

          if (!loanSnap.exists()) return;
          const loan = loanSnap.data();
          if (loan.returned_at) return;

          const itemRef = doc(db, "items", loan.item_id);
          const itemSnap = await tx.get(itemRef);
          if (!itemSnap.exists()) return;

          tx.update(loanRef, {
            returned_at: serverTimestamp()
          });

          tx.update(itemRef, {
            available: (itemSnap.data().available || 0) + loan.qty
          });
        });
      }

      alert("返却しました！");
      loadUnreturned();

    } catch (err) {
      console.error(err);
      alert("返却処理中にエラーが発生しました");
    }
  });

  function formatDate(ts) {
    if (!ts) return "";
    return ts.toDate().toLocaleString("ja-JP");
  }
</script>

</body>
</html>
