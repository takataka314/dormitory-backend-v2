<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>物品追加</title>
  <link rel="stylesheet" href="styles.css">

</head>
<body>
<div class="header">
  <button onclick="location.href='staff_menu.html'" class="staff-only">〇執管理メニューへ戻る</button>
  <h1>物品追加（CSV / Excel）</h1>
  <button id="logoutBtn">ログアウト</button>
</div>

<br>
<button class="btn" onclick="uploadItems()">以下の内容を追加する</button>
<br>

<input type="file" id="fileInput" accept=".csv, .xlsx">
<button class="btn" onclick="loadFile()">読み込む</button>

<h2>読み込み結果</h2>
<table id="previewTable"></table>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script type="module">
  import { db } from "./firebase.js";
  import {
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /**********************
   * 権限チェック（仮）
   * ※ Auth 導入後に置き換え
   **********************/
  function checkStaff() {
    // 今は全員OK（あとで制限）
    return true;
  }

  if (!checkStaff()) {
    alert("スタッフ専用ページです");
    window.location.href = "/login.html";
  }

  /**********************
   * ログアウト（仮）
   **********************/
  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    // Auth導入後は signOut(auth)
    window.location.href = "/login.html";
  });

  /**********************
   * ファイル読み込み
   **********************/
  let parsedData = [];

  window.loadFile = function () {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
      alert("ファイルを選択してください");
      return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
      const data = e.target.result;
      let workbook;

      if (file.name.endsWith(".xlsx")) {
        workbook = XLSX.read(new Uint8Array(data), { type: "array" });
      } else {
        workbook = XLSX.read(data, { type: "string" });
      }

      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      displayData(rows);
    };

    file.name.endsWith(".xlsx")
      ? reader.readAsArrayBuffer(file)
      : reader.readAsText(file);
  };

  /**********************
   * プレビュー表示
   **********************/
  function displayData(rows) {
    parsedData = [];
    const table = document.getElementById("previewTable");
    table.innerHTML = "";

    table.insertAdjacentHTML(
      "beforeend",
      `<tr><th>カテゴリー</th><th>物品名</th><th>個数</th></tr>`
    );

    rows.slice(1).forEach(row => {
      if (row.length < 3) return;

      const [category, name, qty] = row;

      parsedData.push({
        category,
        name,
        qty: Number(qty),
        createdAt: serverTimestamp()
      });

      table.insertAdjacentHTML(
        "beforeend",
        `<tr><td>${category}</td><td>${name}</td><td>${qty}</td></tr>`
      );
    });

    if (parsedData.length === 0) {
      alert("データが読み込めませんでした");
    }
  }

  /**********************
   * Firestoreへ一括追加
   **********************/
  window.uploadItems = async function () {
    if (parsedData.length === 0) {
      alert("先にファイルを読み込んでください");
      return;
    }

    try {
      const colRef = collection(db, "items");

      for (const item of parsedData) {
        await addDoc(colRef, item);
      }

      alert("Firestore に追加しました！");
      parsedData = [];
      document.getElementById("previewTable").innerHTML = "";

    } catch (err) {
      console.error(err);
      alert("Firestore 保存中にエラーが発生しました");
    }
  };
</script>


</body>
</html>
