<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>貸出・返却履歴一覧</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body onload="loadHistory()">
<div class="header">
  <button onclick="location.href='staff_menu.html'" class="staff-only">〇執管理メニューへ戻る</button>
  <h2>貸出・返却履歴一覧（スタッフ専用）</h2>
  <button id="logoutBtn">ログアウト</button>
</div>

  <!-- ▼ 検索欄・表示切替 UI -->
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="検索（部屋・物品・借りた人）" style="width:300px;">
    <label>
      <input type="checkbox" id="onlyNotReturned" checked> 未返却のみ表示
    </label>
    <button type="button" onclick="loadHistory()">検索</button>

  </div>

  <table id="historyTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>物品</th>
        <th>カテゴリ</th>
        <th>借りた人</th>
        <th>個数</th>
        <th>部屋</th>
        <th>貸出日時</th>
        <th>返却日時</th>
        <th>対応スタッフ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    doc,
    getDoc,
    collection,
    getDocs,
    query,
    where,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let currentUser = null;
  let isStaff = false;

  /**********************
   * 認証状態監視
   **********************/
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/login.html";
      return;
    }

    currentUser = user;

    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists()) {
      alert("権限情報がありません");
      await signOut(auth);
      return;
    }

    isStaff = userDoc.data().role === "staff";

    if (!isStaff) {
      alert("スタッフ専用ページです");
      window.location.href = "/login.html";
      return;
    }

    showStaffButtons();
    loadHistory();
  });

  /**********************
   * ログアウト
   **********************/
  document.getElementById("logoutBtn")?.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "/login.html";
  });

  /**********************
   * スタッフ表示制御
   **********************/
  function showStaffButtons() {
    document.querySelectorAll(".staff-only").forEach(el => {
      el.style.display = "inline-block";
    });
  }

  /**********************
   * 履歴取得（Firestore）
   **********************/
  async function loadHistory() {
    const qText = document.getElementById("searchInput")?.value || "";
    const onlyNot = document.getElementById("onlyNotReturned")?.checked;

    let qRef = collection(db, "history");
    let qFinal;

    if (onlyNot) {
      qFinal = query(
        qRef,
        where("returned_at", "==", null),
        orderBy("borrowed_at", "desc")
      );
    } else {
      qFinal = query(
        qRef,
        orderBy("borrowed_at", "desc")
      );
    }

    const snap = await getDocs(qFinal);
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";

    snap.forEach(docSnap => {
      const r = docSnap.data();
      const text = `${r.item_name} ${r.category} ${r.lender_name} ${r.room}`;
      if (qText && !text.includes(qText)) return;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${docSnap.id}</td>
        <td>${r.item_name}</td>
        <td>${r.category}</td>
        <td>${r.lender_name}</td>
        <td>${r.qty}</td>
        <td>${r.room}</td>
        <td>${formatDate(r.borrowed_at)}</td>
        <td class="${r.returned_at ? "returned" : "not-returned"}">
          ${r.returned_at ? formatDate(r.returned_at) : "未返却"}
        </td>
        <td>${r.staff_name || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function formatDate(ts) {
    if (!ts) return "";
    return ts.toDate().toLocaleString("ja-JP");
  }
</script>



</body>
</html>
