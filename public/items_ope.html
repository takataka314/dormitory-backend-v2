<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>物品管理</title>
<link rel="stylesheet" href="styles.css">
<style>
  tr.unsaved { background: #fff6cc; }
</style>
</head>
<body>

<div class="header">
  <button onclick="location.href='staff_menu.html'" class="staff-only" style="display:none">
    〇執管理メニューへ戻る
  </button>
  <h1>物品管理</h1>
  <button id="logoutBtn">ログアウト</button>
</div>

<br>

<div style="margin-top:20px;">
  <input
    type="text"
    id="searchInput"
    placeholder="カテゴリ・物品名・備考を検索"
    style="width:300px; padding:5px;">
</div>

<button id="saveAllBtn">一括保存</button>

<table id="itemsTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>カテゴリ</th>
      <th>物品名</th>
      <th>在庫数</th>
      <th>備考</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    doc,
    writeBatch,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let allItems = [];

  /**********************
   * 認証 & スタッフ判定
   **********************/
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists() || snap.data().role !== "staff") {
      alert("スタッフ専用ページです");
      await signOut(auth);
      location.href = "login.html";
      return;
    }

    document.querySelectorAll(".staff-only").forEach(el => {
      el.style.display = "inline-block";
    });

    loadItems();
  });

  /**********************
   * ログアウト
   **********************/
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    location.href = "login.html";
  });

  /**********************
   * データ取得
   **********************/
  async function loadItems() {
    const snap = await getDocs(collection(db, "items"));
    allItems = snap.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));
    renderItems();
  }

  /**********************
   * 表示 & 検索
   **********************/
  function renderItems() {
    const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
    const tbody = document.querySelector("#itemsTable tbody");
    tbody.innerHTML = "";

    allItems
      .filter(item => {
        if (!keyword) return true;
        return (
          (item.category || "").toLowerCase().includes(keyword) ||
          (item.name || "").toLowerCase().includes(keyword) ||
          (item.note || "").toLowerCase().includes(keyword)
        );
      })
      .forEach(item => {
        const tr = document.createElement("tr");
        tr.dataset.id = item.id;

        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.category}</td>
          <td>${item.name}</td>
          <td>
            <button class="decBtn">-</button>
            <input type="number" class="qtyInput"
              value="${item.available ?? 0}"
              min="0" style="width:60px;text-align:center;">
            <button class="incBtn">+</button>
          </td>
          <td>
            <input type="text" class="noteInput" value="${item.note || ""}">
          </td>
        `;

        const qtyInput = tr.querySelector(".qtyInput");
        const noteInput = tr.querySelector(".noteInput");

        function markDirty() {
          tr.classList.add("unsaved");
        }

        tr.querySelector(".incBtn").onclick = () => {
          qtyInput.value = Number(qtyInput.value) + 1;
          markDirty();
        };
        tr.querySelector(".decBtn").onclick = () => {
          qtyInput.value = Math.max(0, Number(qtyInput.value) - 1);
          markDirty();
        };

        qtyInput.addEventListener("input", markDirty);
        noteInput.addEventListener("input", markDirty);

        tbody.appendChild(tr);
      });
  }

  document.getElementById("searchInput").addEventListener("input", renderItems);

  /**********************
   * 一括保存（Firestore）
   **********************/
  document.getElementById("saveAllBtn").addEventListener("click", async () => {
    const rows = document.querySelectorAll("#itemsTable tbody tr.unsaved");
    if (rows.length === 0) {
      alert("変更された行がありません");
      return;
    }

    try {
      const batch = writeBatch(db);

      rows.forEach(tr => {
        const ref = doc(db, "items", tr.dataset.id);
        batch.update(ref, {
          available: Number(tr.querySelector(".qtyInput").value),
          note: tr.querySelector(".noteInput").value
        });
      });

      await batch.commit();

      alert("保存しました");
      rows.forEach(tr => tr.classList.remove("unsaved"));
      loadItems();

    } catch (err) {
      console.error(err);
      alert("保存に失敗しました");
    }
  });

  /**********************
   * ページ離脱警告
   **********************/
  window.addEventListener("beforeunload", (e) => {
    if (document.querySelectorAll("tr.unsaved").length > 0) {
      e.preventDefault();
      e.returnValue = "";
    }
  });
</script>

</body>
</html>
